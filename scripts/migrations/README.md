# Миграции данных

Эта папка содержит скрипты для миграции данных в системе FastAPI e-commerce.

## Файлы миграций

### 1. `migrate_images_to_minio.py`
**Назначение**: Миграция изображений продуктов из локального хранилища в MinIO (основная версия)

**Что делает**:
- Читает данные о изображениях из таблицы `product_images`
- Проверяет существование файлов в локальном хранилище
- Загружает изображения в MinIO bucket `product-images`
- Обновляет пути в базе данных на новые MinIO пути
- Генерирует отчет о миграции

**Использование**:
```bash
python migrations/migrate_images_to_minio.py
```

### 2. `migrate_images_to_minio_final.py`
**Назначение**: Финальная версия миграции изображений (использовалась для успешной миграции)

**Что делает**: То же самое, что и основная версия, но с исправлениями для minio-py

**Использование**:
```bash
python migrations/migrate_images_to_minio_final.py
```

### 3. `migrate_products_data.py`
**Назначение**: Анализ и резервное копирование данных продуктов (без изображений)

**Что делает**:
- Генерирует отчет о текущих данных
- Проверяет целостность данных и связи
- Создает резервную копию данных
- Предоставляет рекомендации по улучшению

**Использование**:
```bash
python migrations/migrate_products_data.py
```

## Скрипты проверки и диагностики

### 4. `check_data.py`
**Назначение**: Проверка данных в базе данных

**Что делает**:
- Проверяет количество записей в таблицах
- Показывает примеры данных

**Использование**:
```bash
python migrations/check_data.py
```

### 5. `check_products.py`
**Назначение**: Детальная проверка таблицы продуктов

**Что делает**:
- Показывает количество продуктов и категорий
- Отображает первые 5 записей из каждой таблицы

**Использование**:
```bash
python migrations/check_products.py
```

### 6. `check_table_structure.py`
**Назначение**: Проверка структуры таблиц базы данных

**Что делает**:
- Показывает все колонки и их типы для таблиц products, categories, product_images

**Использование**:
```bash
python migrations/check_table_structure.py
```

### 7. `test_minio.py`
**Назначение**: Тестирование подключения к MinIO

**Что делает**:
- Проверяет подключение к MinIO серверу
- Тестирует создание bucket и загрузку файлов
- Использует библиотеку minio-py

**Использование**:
```bash
python migrations/test_minio.py
```

## Файлы отчетов

### 8. `migration_report.json`
**Назначение**: Отчет о выполненной миграции изображений

**Содержит**:
- Статистику миграции (5669 файлов, 100% успех)
- Информацию о каждом продукте
- Список ошибок (если были)

## Структура данных

### Таблицы базы данных:
- **products**: Основная информация о продуктах
- **categories**: Категории продуктов
- **product_images**: Изображения продуктов и их метаданные

### MinIO структура:
- **Bucket**: `product-images`
- **Пути**: `products/{product_id}/{filename}`

## Результаты миграции

### Успешная миграция изображений (2025-08-27):
- **Всего файлов**: 5669
- **Успешно загружено**: 5669 (100%)
- **Ошибок**: 0 (0%)
- **Продуктов обработано**: 5669

### Сохраненные данные:
- **Продукты**: 5821 запись
- **Категории**: 1 запись (kholodilniki)
- **Изображения**: 5669 записей

## Требования к системе

### Программное обеспечение:
- Python 3.8+
- PostgreSQL 15
- MinIO (S3-совместимое хранилище)
- Docker & Docker Compose

### Python библиотеки:
```bash
pip install minio sqlalchemy psycopg2-binary tqdm
```

### Переменные окружения:
```bash
DATABASE_URL=postgresql://postgres:password@localhost:5433/fastapi_shop
```

## Порядок использования

1. **Проверка системы**:
   ```bash
   python migrations/test_minio.py
   python migrations/check_data.py
   ```

2. **Анализ данных**:
   ```bash
   python migrations/migrate_products_data.py
   ```

3. **Миграция изображений**:
   ```bash
   python migrations/migrate_images_to_minio.py
   ```

4. **Проверка результатов**:
   ```bash
   python migrations/check_products.py
   ```

## Безопасность

⚠️ **Важно**: 
- Всегда создавайте резервные копии перед выполнением миграций
- Проверяйте данные после миграции
- Тестируйте миграции на копии данных перед применением к продакшену

## Поддержка

При возникновении проблем:
1. Проверьте логи выполнения
2. Убедитесь, что все сервисы запущены
3. Проверьте подключение к базе данных и MinIO
4. Обратитесь к отчетам миграции для диагностики
